<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="iOS开发-连续拍照异步按顺序批量上传图片" /><meta name="author" content="Ouyang Rong" /><meta property="og:locale" content="en_US" /><meta name="description" content="一、数据模型" /><meta property="og:description" content="一、数据模型" /><link rel="canonical" href="https://ouyangrong.com/posts/UploadImg/" /><meta property="og:url" content="https://ouyangrong.com/posts/UploadImg/" /><meta property="og:site_name" content="Ouyang Rong" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-06-29T13:38:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="iOS开发-连续拍照异步按顺序批量上传图片" /><meta name="twitter:site" content="@ouyangrong1313" /><meta name="twitter:creator" content="@Ouyang Rong" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ouyang Rong"},"dateModified":"2023-06-29T13:38:00+08:00","datePublished":"2023-06-29T13:38:00+08:00","description":"一、数据模型","headline":"iOS开发-连续拍照异步按顺序批量上传图片","mainEntityOfPage":{"@type":"WebPage","@id":"https://ouyangrong.com/posts/UploadImg/"},"url":"https://ouyangrong.com/posts/UploadImg/"}</script><title>iOS开发-连续拍照异步按顺序批量上传图片 | Ouyang Rong</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ouyang Rong"><meta name="application-name" content="Ouyang Rong"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-4EXCTKYR2M"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-4EXCTKYR2M'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/images/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ouyang Rong</a></div><div class="site-subtitle font-italic">Stay Hungry, Stay Foolish.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ouyangrong1313" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/ouyangrong1313" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['951607559','qq.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>iOS开发-连续拍照异步按顺序批量上传图片</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>iOS开发-连续拍照异步按顺序批量上传图片</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Ouyang Rong </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Jun 29, 2023, 1:38 PM +0800" prep="on" > Jun 29, 2023 <i class="unloaded">2023-06-29T13:38:00+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2714 words">15 min</span></div></div><div class="post-content"><h1 id="一数据模型">一、数据模型</h1><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre><td class="rouge-code"><pre>@interface SSTEditTaskSujectFinishedPictureModel:NSObject

/**
 * 图片上传的日期
 */
@property (nonatomic,copy) NSString *uploadDate;

/**
 * 图片关联的科目
 */
@property (nonatomic,copy) NSString *course;

/**
 * 图片关联的学生
 */
@property (nonatomic,copy) NSString *vipId;

@property (nonatomic,copy) NSString *studentName;

/**
 * 图片id
 */
@property (nonatomic,copy) NSString *homeworkPictureId;

/**
 * 图片id 对比前后端的数据是否重复问题
 */
@property (nonatomic,copy) NSString *derverFileId;

@property (nonatomic,copy) NSString *timestampStr;

/**
 * 图片路径
 */
@property (nonatomic,copy) NSString *image;

@property (nonatomic,copy) NSString *originImageUrl;

@property (nonatomic,copy) NSString *originPictureUrl;

/**
 * 图片批注状态，0默认，1批注， 2补拍，3不全, 4模糊，5上传中(本地管理) ，6上传失败(本地管理) ，7未上传(本地管理)
 */
@property (nonatomic,assign) SSTHomeworkPictureState correctStatus;

/**
 * 图片的本地路径
*/
@property (nonatomic,copy) NSString *localPath;

/**
 * 本地上传的图片
*/
@property (nonatomic,strong) UIImage *localImage;

/**
 * 是否是本地 0:服务器 1：本地
 */
@property (nonatomic,assign)BOOL isLocalData;

/**
 * 序号
 */
@property (nonatomic,assign)int index;

/**
 * 推荐题目记录Id
 */
@property (nonatomic,copy) NSString *questionRecommendRecordId;

@end

</pre></table></code></div></div><h1 id="二本地数据管理">二、本地数据管理</h1><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre>#import "DataBaseHelper.h"
#import "SSTEditTaskModel.h"
#define kHOMEWORKImage_TABLE_NAME @"HomeworkImageTable"

NS_ASSUME_NONNULL_BEGIN

@interface DataBaseHelper (ImageUpload)

/**
 *创建作业图片信息表
 */
-(void)creatHomeworkImageInfoTable;

/**
 *保存作业图片信息
 */
-(BOOL)saveHomeworkImageInfo:(SSTEditTaskSujectFinishedPictureModel *)imageModel;

/**
 * 获取所有的作业图片信息
 */
-(NSArray &lt;SSTEditTaskSujectFinishedPictureModel *&gt;*)getAllHomeworkImageModel;

/**
 * 删除作业图片信息
 */
-(BOOL)deleteHomeworkImageModel:(SSTEditTaskSujectFinishedPictureModel *)imageModel;

-(BOOL)deleteHomeworkImageModelBeforeDate:(NSString *)date;

-(BOOL)updateImageModel:(SSTEditTaskSujectFinishedPictureModel *)imageModel withImageModelKey:(NSString *)key andImageModelValue:(NSString *)value;

@end

NS_ASSUME_NONNULL_END

</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
</pre><td class="rouge-code"><pre>#import "DataBaseHelper+ImageUpload.h"

@implementation DataBaseHelper (ImageUpload)

-(NSArray *)obtainTaskImageInfoTableField {
    NSArray *array = @[@"uploadDate",@"vipId",@"studentName",@"course",@"derverFileId",@"localPath",@"correctStatus",@"timestampStr"];
    return array;
}

/**
 * 创建作业图片的表
 */
-(void)creatHomeworkImageInfoTable{
    [[DataBaseHelper sharedInstance] DatabaseWithDBName:kHOMEWORKImage_TABLE_NAME];
    NSDictionary *dict = @{@"uploadDate":@(DBdatatypeNSString),
                           @"vipId":@(DBdatatypeNSString),
                           @"studentName":@(DBdatatypeNSString),
                           @"course":@(DBdatatypeNSString),
                           @"derverFileId":@(DBdatatypeNSString),
                           @"localPath":@(DBdatatypeNSString),
                           @"timestampStr":@(DBdatatypeNSString),
                           @"correctStatus":@(DBdatatypeInteger)};
    [self createTable:kHOMEWORKImage_TABLE_NAME WithKey:dict];
}

/**
 *保存作业图片信息
 */
-(BOOL)saveHomeworkImageInfo:(SSTEditTaskSujectFinishedPictureModel *)imageModel {
    NSDictionary *dict = @{@"uploadDate":imageModel.uploadDate,
                           @"vipId":imageModel.vipId,
                           @"studentName":imageModel.studentName,
                           @"course":imageModel.course,
                           @"derverFileId":imageModel.derverFileId,
                           @"localPath":imageModel.localPath,
                           @"timestampStr":imageModel.timestampStr,
                           @"correctStatus":@(imageModel.correctStatus)};
    BOOL insert = [self insertInTable:kHOMEWORKImage_TABLE_NAME WithKey:dict];
    SSLog(@"%@-%@图片数据保存%@",imageModel.uploadDate,imageModel.studentName,insert?@"成功":@"失败");
    if (insert) {
        [self saveUploadHomewrokPhoto:imageModel];
    }
    return insert;
}

/**
 * 获取所有的作业图片信息
 */
-(NSArray &lt;SSTEditTaskSujectFinishedPictureModel *&gt;*)getAllHomeworkImageModel {
    NSMutableArray *tempArray = [[NSMutableArray alloc] init];
    NSDictionary *keyDict = @{@"uploadDate":@(DBdatatypeNSString),
                           @"vipId":@(DBdatatypeNSString),
                           @"studentName":@(DBdatatypeNSString),
                           @"course":@(DBdatatypeNSString),
                           @"derverFileId":@(DBdatatypeNSString),
                           @"localPath":@(DBdatatypeNSString),
                           @"timestampStr":@(DBdatatypeNSString),
                           @"correctStatus":@(DBdatatypeInteger)};
    tempArray = [self selectInTable:kHOMEWORKImage_TABLE_NAME WithKey:keyDict orderKey:@"timestampStr" orderModel:@"DESC"];
    NSMutableArray *nodeArr = [NSMutableArray array];
    for (NSDictionary *nodeDict in tempArray) {
        SSTEditTaskSujectFinishedPictureModel *voice = [[SSTEditTaskSujectFinishedPictureModel alloc] init];
        voice.vipId = [nodeDict objectForKey:@"vipId"];
        voice.uploadDate = [nodeDict objectForKey:@"uploadDate"];
        voice.studentName = [nodeDict objectForKey:@"studentName"];
        voice.course = [nodeDict objectForKey:@"course"];
        voice.derverFileId = [nodeDict objectForKey:@"derverFileId"];
        voice.localPath = [nodeDict objectForKey:@"localPath"];
        voice.correctStatus = [[nodeDict objectForKey:@"correctStatus"] integerValue];
        voice.localImage = [nodeDict objectForKey:@"localImage"];
        voice.timestampStr = [nodeDict objectForKey:@"timestampStr"];
        voice.localImage = [self getHomeworkImageWithModel:voice];
        [nodeArr addObject:voice];
    }
     return nodeArr;
}

-(NSArray &lt;SSTEditTaskSujectFinishedPictureModel *&gt;*)getAllHomeworkImageModelBeforeDate:(NSString *)beforeDate {
    NSMutableArray *tempArray = [[NSMutableArray alloc] init];
    NSDictionary *keyDict = @{@"uploadDate":@(DBdatatypeNSString),
                           @"vipId":@(DBdatatypeNSString),
                           @"studentName":@(DBdatatypeNSString),
                           @"course":@(DBdatatypeNSString),
                           @"derverFileId":@(DBdatatypeNSString),
                           @"localPath":@(DBdatatypeNSString),
                           @"timestampStr":@(DBdatatypeNSString),
                           @"correctStatus":@(DBdatatypeInteger)};
    NSString *selectQuery = [NSString stringWithFormat:@"SELECT * FROM %@ WHERE uploadDate &lt; ?",kHOMEWORKImage_TABLE_NAME]; // 查询语句
    tempArray = [self selectInTable:kHOMEWORKImage_TABLE_NAME withKey:keyDict andQuery:selectQuery whereCondition:beforeDate];
    
    NSMutableArray *nodeArr = [NSMutableArray array];
    for (NSDictionary *nodeDict in tempArray) {
        SSTEditTaskSujectFinishedPictureModel *voice = [[SSTEditTaskSujectFinishedPictureModel alloc] init];
        voice.vipId = [nodeDict objectForKey:@"vipId"];
        voice.uploadDate = [nodeDict objectForKey:@"uploadDate"];
        voice.studentName = [nodeDict objectForKey:@"studentName"];
        voice.course = [nodeDict objectForKey:@"course"];
        voice.derverFileId = [nodeDict objectForKey:@"derverFileId"];
        voice.localPath = [nodeDict objectForKey:@"localPath"];
        voice.correctStatus = [[nodeDict objectForKey:@"correctStatus"] integerValue];
        voice.localImage = [nodeDict objectForKey:@"localImage"];
        voice.timestampStr = [nodeDict objectForKey:@"timestampStr"];
        voice.localImage = [self getHomeworkImageWithModel:voice];
        [nodeArr addObject:voice];
    }
     return nodeArr;
}

/**
 * 删除作业图片信息
 */
-(BOOL)deleteHomeworkImageModel:(SSTEditTaskSujectFinishedPictureModel *)imageModel {
    BOOL isDelete = [self deleteInTable:kHOMEWORKImage_TABLE_NAME withConditonKey:@"derverFileId" andConditonValue:imageModel.derverFileId];
    if (isDelete) {
        [self deleteUploadPhoto:imageModel];
    }
    return isDelete;
}

-(BOOL)deleteHomeworkImageModelBeforeDate:(NSString *)date{
    BOOL isAllDelete = YES;
    NSArray *imgModelArr = [self getAllHomeworkImageModelBeforeDate:date];
    for (SSTEditTaskSujectFinishedPictureModel *pModel in imgModelArr) {
        BOOL isDelete = [self deleteHomeworkImageModel:pModel];
        if (!isDelete) {
            isAllDelete = NO;
        }
    }
    return isAllDelete;
}

-(BOOL)updateImageModel:(SSTEditTaskSujectFinishedPictureModel *)imageModel withImageModelKey:(NSString *)key andImageModelValue:(NSString *)value{
    BOOL isUpdate = [self updateInTable:kHOMEWORKImage_TABLE_NAME columnName:key newValue:value whereCondition:@"derverFileId" andConditionValue:imageModel.derverFileId];
    return isUpdate;
}

-(void)saveUploadHomewrokPhoto:(SSTEditTaskSujectFinishedPictureModel *)uploadImage{
    dispatch_async(dispatch_get_global_queue(0, 0), ^{
        UIImage *image = uploadImage.localImage;
        // 本地沙盒目录 + CheckHomewor + [NSDate nowDate]
        NSString *imgPath = [SSUtility getUploadHomeworkPhotoDirectoryWithSubject:uploadImage.course withDate:uploadImage.uploadDate vipId:uploadImage.vipId];
        NSString *localImagePath = [imgPath stringByAppendingFormat:@"%@",uploadImage.localPath];
        // 将取得的图片写入本地的沙盒中，其中0.5表示压缩比例，1表示不压缩，数值越小压缩比例越大
        BOOL success = [UIImageJPEGRepresentation(image,1) writeToFile:localImagePath atomically:YES];
        if (success){
            NSLog(@"上传中的作业写入本地成功");
        }
    });
}

-(UIImage*)getHomeworkImageWithModel:(SSTEditTaskSujectFinishedPictureModel *)imageModel {
    NSString *imgPath = [SSUtility getUploadHomeworkPhotoDirectoryWithSubject:imageModel.course withDate:imageModel.uploadDate vipId:imageModel.vipId];
    NSString *localImagePath = [imgPath stringByAppendingFormat:@"%@",imageModel.localPath];
    NSData *imgData = [NSData dataWithContentsOfFile:localImagePath];
    UIImage *img = [UIImage imageWithData:imgData];
    return img;
}

/**
 * 删除作业图片
*/
-(void)deleteUploadPhoto:(SSTEditTaskSujectFinishedPictureModel *)uploadImage{
    // 本地沙盒目录 + CheckHomewor + [NSDate nowDate]
    NSString *imgPath = [SSUtility getUploadHomeworkPhotoDirectoryWithSubject:uploadImage.course withDate:uploadImage.uploadDate vipId:uploadImage.vipId];
    NSString *localImagePath = [imgPath stringByAppendingFormat:@"%@",uploadImage.localPath];
    if ([[NSFileManager defaultManager] removeItemAtPath:localImagePath error:nil]) {
        NSLog(@" --- 删除成功 --- %@",uploadImage.derverFileId);
    }else {
        NSLog(@" --- 删除失败 --- %@",uploadImage.derverFileId);
    }
}

@end

</pre></table></code></div></div><h1 id="三图片异步上传逻辑">三、图片异步上传逻辑</h1><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>#import &lt;Foundation/Foundation.h&gt;
#import "SSTEditTaskModel.h"

NS_ASSUME_NONNULL_BEGIN

@interface SSImageUploadQueueManager : NSObject

@property (nonatomic, assign) BOOL isUploading;

+ (instancetype)shareManager;

- (void)enqueueImageModel:(SSTEditTaskSujectFinishedPictureModel *)imageModel;

- (void)reUploadImageModelArr:(NSArray&lt;SSTEditTaskSujectFinishedPictureModel *&gt; *)imageModelArr;

- (void)deleteUpoadImageModel:(SSTEditTaskSujectFinishedPictureModel *)imageModel;

- (void)setAllUploadImageModelState:(SSTHomeworkPictureState)state;

@end

NS_ASSUME_NONNULL_END

</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
</pre><td class="rouge-code"><pre>#import "SSImageUploadQueueManager.h"
#import &lt;AliyunOSSiOS/OSSService.h&gt;
#import "OssfsTokenModel.h"
#import "DataBaseHelper+ImageUpload.h"

static SSImageUploadQueueManager *_manager = nil;
static dispatch_queue_t _queueUploadBegin = nil; // 创建串行队列 - 保证多次图片上传请求按顺序执行；
static dispatch_semaphore_t _semaphoreBegin = nil;

@interface SSImageUploadQueueManager ()&lt;NSCopying,NSMutableCopying&gt;

@property (nonatomic, strong) NSMutableArray *uploadQueue;

@end

@implementation SSImageUploadQueueManager

+ (instancetype)shareManager {
    return [[self alloc] init];
}

- (instancetype)init {
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        _manager = [super init];
        _uploadQueue = [NSMutableArray array];
        _queueUploadBegin = dispatch_queue_create("com.uploadHomeworkImageToOSS.xiaodiandou.tast", DISPATCH_QUEUE_SERIAL);
        _semaphoreBegin = dispatch_semaphore_create(1); // 设置信号总量为1，保证只有一个进程执行
    });
    return _manager;
}

+ (id)allocWithZone:(struct _NSZone *)zone {
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        _manager = [super allocWithZone:zone];
    });
    return _manager;
}

- (nonnull id)copyWithZone:(NSZone *)zone {
    return _manager;
}

- (nonnull id)mutableCopyWithZone:(NSZone *)zone {
    return _manager;
}
// 只在拍照的时候，从这里添加；
- (void)enqueueImageModel:(SSTEditTaskSujectFinishedPictureModel *)imageModel {
    [[DataBaseHelper sharedInstance] saveHomeworkImageInfo:imageModel];
    [self.uploadQueue addObject:imageModel];
    [self startUploadingIfIdle];
}

- (void)reUploadImageModelArr:(NSArray&lt;SSTEditTaskSujectFinishedPictureModel *&gt; *)imageModelArr {
    [self.uploadQueue addObjectsFromArray:imageModelArr];
    if (self.uploadQueue.count == imageModelArr.count) {
        [self uploadNextImageModel]; // 说明上传队列里，没有在上传的图片了，直接去上传
    }
}

- (void)deleteUpoadImageModel:(SSTEditTaskSujectFinishedPictureModel *)imageModel {
    // 定义一个标识符来查找的值
    NSString *targetIdentifier = imageModel.derverFileId;
    // 创建NSPredicate对象
    NSPredicate *predicate = [NSPredicate predicateWithFormat:@"derverFileId == %@", targetIdentifier];
    // 使用NSPredicate过滤NSArray
    NSArray *filteredArray = [self.uploadQueue filteredArrayUsingPredicate:predicate];
    // 检查是否有匹配的Model对象
    if (filteredArray.count &gt; 0) {
        // 找到了匹配的Model对象
        for (SSTEditTaskSujectFinishedPictureModel *pModel in filteredArray) {
            [self.uploadQueue removeObject:pModel];
        }
    } else {
        // 没有找到匹配的Model对象
        NSLog(@" -- 没有找到匹配的Model对象 -- ");
    }
}

- (void)setAllUploadImageModelState:(SSTHomeworkPictureState)state {
    NSArray *uploadImgAllArr = [[DataBaseHelper sharedInstance] getAllHomeworkImageModel];
    for (SSTEditTaskSujectFinishedPictureModel *imageModel in uploadImgAllArr) {
        [[DataBaseHelper sharedInstance] updateImageModel:imageModel withImageModelKey:@"correctStatus" andImageModelValue:[NSString stringWithFormat:@"%ld",state]];
    }
}

- (SSTEditTaskSujectFinishedPictureModel *)dequeueImageModel {
    SSTEditTaskSujectFinishedPictureModel *imageModel = [self.uploadQueue firstObject];
    if (imageModel) {
        [self.uploadQueue removeObjectAtIndex:0];
    }
    return imageModel;
}

- (void)startUploadingIfIdle {
    if (self.uploadQueue.count == 1) {
        [self uploadNextImageModel];
    }
}

- (void)uploadNextImageModel {
    
    SSTEditTaskSujectFinishedPictureModel *imageModel = [self dequeueImageModel];
    if (imageModel) {
        // 执行上传操作，可以使用网络请求库（如NSURLSession）将图片上传到服务器
        // 在上传完成后的回调中，调用 [self uploadNextImage] 继续上传下一张图片
        // 在上传失败或取消时，可以根据需要进行错误处理或重试
        WS(weakSelf);
        self.isUploading = YES;
        dispatch_async(_queueUploadBegin, ^{
            //等待信号量
            dispatch_semaphore_wait(_semaphoreBegin, DISPATCH_TIME_FOREVER);
                NSString *accessToken = [[NSUserDefaults standardUserDefaults] objectForKey:kUserToken];
                NSString *urlString = [HTTP_upload_getOssfsToken stringByAppendingString:[NSString stringWithFormat:@"?accessToken=%@",accessToken]];

            //[[DataBaseHelper sharedInstance] updateImageModel:imageModel withImageModelKey:@"correctStatus" andImageModelValue:@"11"];

                [XWHttpClient xw_postWithUrlString:urlString Params:nil DefaultHUD:NO RepeatNum:1 TimeOutSecond:10 SuccessBlock:^(id returnValue) {
                    NSLog(@"  ----- getOssfsToken - returnValue： %@",returnValue);
                    //处理耗时操作的代码块...
                    dispatch_async(dispatch_get_global_queue(0, 0), ^{
                        OssfsTokenModel *ossfsTokenModel = [OssfsTokenModel mj_objectWithKeyValues:DicGetValue(returnValue,@"data")];
                        id&lt;OSSCredentialProvider&gt; credential = [[OSSStsTokenCredentialProvider alloc] initWithAccessKeyId:ossfsTokenModel.accessKeyId secretKeyId:ossfsTokenModel.accessKeySecret securityToken:ossfsTokenModel.securityToken];
                        OSSClient *client = [[OSSClient alloc] initWithEndpoint:ossfsTokenModel.endpoint credentialProvider:credential];
                        OSSPutObjectRequest * put = [OSSPutObjectRequest new];
                        put.bucketName = ossfsTokenModel.bucket;
                        NSString * uploadImgPath = ossfsTokenModel.uploadImgPath;
                        NSString * objectKeyStr = [uploadImgPath substringFromIndex:1]; //去掉图片路径的第一个斜杠
                        put.objectKey = objectKeyStr;
                        imageModel.localImage = [UIImage compressImage:imageModel.localImage toByte:800000];
                        NSData *imageData = UIImageJPEGRepresentation(imageModel.localImage, 1);
                        put.uploadingData = imageData; // UIImageJPEGRepresentation(img.localImage,1);
                        put.uploadProgress = ^(int64_t bytesSent, int64_t totalByteSent, int64_t totalBytesExpectedToSend) {
                            NSString *sendSize = [SSUtility transformedValue:[NSNumber numberWithUnsignedLongLong:totalByteSent]];
                            NSString *totalSize = [SSUtility transformedValue:[NSNumber numberWithUnsignedLongLong:totalBytesExpectedToSend]];
                            SSLog(@"上传图片大小为: %@ --- 已上传: %@",totalSize,sendSize);
                        };
                        if (imageModel.questionRecommendRecordId) { // kHOST_ADDRESS -&gt; kUPLOAD_ADDRESS
                            NSString *paramBody = @"{\"vipId\":${x:vipId},\"costype\":${x:costype},\"derverFileId\":${x:derverFileId},\"fileKeys\":${x:fileKeys},\"courseName\":${x:courseName},\"questionRecommendRecordId\":${x:questionRecommendRecordId}}";
                            // 正确的
                            put.callbackParam = @{@"callbackUrl":[NSString stringWithFormat:@"%@/api/parents/xy/homework/uploadPictureNoSubject?accessToken=%@",kHOST_ADDRESS,[SSUtility getUserToken]],
                                                 @"callbackBody":paramBody,
                                             @"callbackBodyType":@"application/json"};
                            put.callbackVar = @{@"x:vipId":imageModel.vipId,
                                                @"x:costype":@"1",
                                                @"x:fileKeys":uploadImgPath,
                                                @"x:courseName":imageModel.course,
                                                @"x:derverFileId":imageModel.derverFileId,
                                                @"x:questionRecommendRecordId":imageModel.questionRecommendRecordId};
                        }else {
                            NSString *paramBody = @"{\"vipId\":${x:vipId},\"costype\":${x:costype},\"derverFileId\":${x:derverFileId},\"fileKeys\":${x:fileKeys},\"courseName\":${x:courseName}}";
                            // 正确的
                            put.callbackParam = @{@"callbackUrl":[NSString stringWithFormat:@"%@/api/parents/xy/homework/uploadPictureNoSubject?accessToken=%@",kHOST_ADDRESS,[SSUtility getUserToken]],
                                                 @"callbackBody":paramBody,
                                             @"callbackBodyType":@"application/json"};
                            put.callbackVar = @{@"x:vipId":imageModel.vipId,
                                                @"x:costype":@"1",
                                                @"x:fileKeys":uploadImgPath,
                                                @"x:courseName":imageModel.course,
                                                @"x:derverFileId":imageModel.derverFileId};
                        }
                        OSSTask * putTask = [client putObject:put];
                        [putTask waitUntilFinished]; // 阻塞直到上传完成
                        [putTask continueWithBlock:^id(OSSTask *task) {
                            OSSPutObjectResult *result = task.result;
                            NSLog(@"Result - requestId: %@, headerFields: %@, servercallback: %@",result.requestId,result.httpResponseHeaderFields,result.serverReturnJsonString);
                            NSDictionary *dataDict = [SSUtility dictionaryWithJsonString:result.serverReturnJsonString];
                            NSString *codeStr = dataDict[@"code"];
                            NSString *msgStr = dataDict[@"msg"];
                            if (!task.error) {
                                if ([codeStr isEqualToString:@"999"]) {
                                    imageModel.image = uploadImgPath; // callback 成功不用回调；
                                    NSString *imgUrl = [SSUtility getImageFullPathWithServerPath:uploadImgPath];
                                    [[SDImageCache sharedImageCache] storeImage:imageModel.localImage forKey:imgUrl completion:^{
                                        NSLog(@" --- &amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp; --- 上传图片成功 --- 本地保存 --- ");
                                    }];
                                    // 上传成功后，删除本地图片数据
                                    [[DataBaseHelper sharedInstance] deleteHomeworkImageModel:imageModel];
//                                    if (successBlock) {
//                                        successBlock(dataDict);
//                                    }
                                    NSLog(@"upload object success!");
                                }else {
                                    dispatch_async(dispatch_get_main_queue(), ^{
                                        [[SSCustomAlertView alloc] setAlertViewTitle:@"" andMessage:msgStr ? msgStr : @"作业上传失败" andhideAlertViewTimeOut:kDefaultAlertTime];
                                    });
//                                    if (errorBlock) {
//                                        errorBlock(task.error);
//                                    }
                                    [[DataBaseHelper sharedInstance] updateImageModel:imageModel withImageModelKey:@"correctStatus" andImageModelValue:@"6"];
                                }
                            } else {
                                NSLog(@"upload object failed, error: %@" , task.error);
                                dispatch_async(dispatch_get_main_queue(), ^{
                                    [[SSCustomAlertView alloc] setAlertViewTitle:@"" andMessage:msgStr ? msgStr : @"作业上传失败" andhideAlertViewTimeOut:kDefaultAlertTime];
                                });
//                                if (errorBlock) {
//                                    errorBlock(task.error);
//                                }
                                [[DataBaseHelper sharedInstance] updateImageModel:imageModel withImageModelKey:@"correctStatus" andImageModelValue:@"6"];

                            }
                            [weakSelf uploadNextImageModel]; // 上传下一张
                            [[NSNotificationCenter defaultCenter] postNotificationName:kUploadImgSuccessNotificationName object:imageModel]; // 提示页面刷新
                            dispatch_semaphore_signal(_semaphoreBegin);
                            task = [client presignPublicURLWithBucketName:ossfsTokenModel.bucket withObjectKey:objectKeyStr];
                            return nil;
                        }];
                    });
                    
                } ErrorBlock:^(id errorCode) {
//                    if (errorBlock) {
//                        errorBlock(errorCode);
//                    }
                    [[DataBaseHelper sharedInstance] updateImageModel:imageModel withImageModelKey:@"correctStatus" andImageModelValue:@"6"];
                    [weakSelf uploadNextImageModel]; // 上传下一张
                    [[NSNotificationCenter defaultCenter] postNotificationName:kUploadImgSuccessNotificationName object:imageModel]; // 提示页面刷新
                    dispatch_semaphore_signal(_semaphoreBegin);
                } FailureBlock:^(id failureInfo) {
//                    if (failBlock) {
//                        failBlock(failureInfo);
//                    }
                    [[DataBaseHelper sharedInstance] updateImageModel:imageModel withImageModelKey:@"correctStatus" andImageModelValue:@"6"];
                    [weakSelf uploadNextImageModel]; // 上传下一张
                    [[NSNotificationCenter defaultCenter] postNotificationName:kUploadImgSuccessNotificationName object:imageModel]; // 提示页面刷新
                    dispatch_semaphore_signal(_semaphoreBegin);
                }];
        
        });

    }else { // 如果有imageModel
        self.isUploading = NO;
    }
    
}

@end

</pre></table></code></div></div><h1 id="四拍照上传操作">四、拍照上传操作</h1><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>    // 上传作业图片
    SSTEditTaskSujectFinishedPictureModel *subjectFinishPictureModel = [[SSTEditTaskSujectFinishedPictureModel alloc] init];
    NSTimeInterval endTime = [[NSDate date] timeIntervalSince1970]*1000;// *1000 是精确到毫秒，不乘就是精确到秒
    NSInteger uploadTime = endTime;
    NSString *localImagePath = [NSString stringWithFormat:@"%@-%zd.jpg",[SSUtility getUserVipId],uploadTime];
    subjectFinishPictureModel.course = self.subject;
    subjectFinishPictureModel.vipId = [SSUtility getUserVipId];
    //subjectFinishPictureModel.uploadDate = [NSDate getDate:[NSDate date] day:4]; // 测试
    subjectFinishPictureModel.uploadDate = [NSDate getDateStringWithNowDate:[NSDate date]];
    subjectFinishPictureModel.derverFileId = [NSString stringWithFormat:@"%@-%zd",[SSUtility getUserVipId],uploadTime];
    subjectFinishPictureModel.localPath = localImagePath;
    subjectFinishPictureModel.timestampStr = [NSString stringWithFormat:@"%zd",uploadTime];
    subjectFinishPictureModel.localImage = _photopImage;
    subjectFinishPictureModel.correctStatus = SSTHomeworkPictureStateUploading; // 上传中
    subjectFinishPictureModel.studentName = [SSUtility getUserCurrentChildName];
    //subjectFinishPictureModel.isLocalData = YES;
    //[[SSTUploadHomeworkPictureManager shareManager] saveUploadingHomewrokPhoto:subjectFinishPictureModel withVipId:self.vipId subject:self.courseName];

    [[SSImageUploadQueueManager shareManager] enqueueImageModel:subjectFinishPictureModel];

</pre></table></code></div></div><h1 id="五上传列表数据获取">五、上传列表数据获取</h1><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>    <span class="n">NSArray</span> <span class="o">*</span><span class="n">uploadImgAllArr</span> <span class="o">=</span> <span class="p">[[</span><span class="n">DataBaseHelper</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="n">getAllHomeworkImageModel</span><span class="p">];</span>
    <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">uploadImgErrorArr</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="n">array</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">SSTEditTaskSujectFinishedPictureModel</span> <span class="o">*</span><span class="n">imageModel</span> <span class="n">in</span> <span class="n">uploadImgAllArr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">imageModel</span><span class="p">.</span><span class="n">correctStatus</span> <span class="o">==</span> <span class="n">SSTHomeworkPictureStateUploadFail</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">[</span><span class="n">uploadImgErrorArr</span> <span class="n">addObject</span><span class="o">:</span><span class="n">imageModel</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">uploadImgArr</span> <span class="n">removeAllObjects</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">uploadImgArr</span> <span class="n">addObjectsFromArray</span><span class="o">:</span><span class="n">uploadImgAllArr</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">uploadImgErrorArr</span> <span class="n">removeAllObjects</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">uploadImgErrorArr</span> <span class="n">addObjectsFromArray</span><span class="o">:</span><span class="n">uploadImgErrorArr</span><span class="p">];</span>
    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">self</span><span class="p">.</span><span class="n">rightBtn</span><span class="p">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="n">uploadImgErrorArr</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">NO</span> <span class="o">:</span> <span class="n">YES</span><span class="p">;</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
    <span class="p">});</span>

</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ios/'>iOS</a>, <a href='/categories/%E5%8A%9F%E8%83%BD/'>功能</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/gcd/" class="post-tag no-text-decoration" >GCD</a> <a href="/tags/fmdb/" class="post-tag no-text-decoration" >FMDB</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=iOS开发-连续拍照异步按顺序批量上传图片 - Ouyang Rong&url=https://ouyangrong.com/posts/UploadImg/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=iOS开发-连续拍照异步按顺序批量上传图片 - Ouyang Rong&u=https://ouyangrong.com/posts/UploadImg/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=iOS开发-连续拍照异步按顺序批量上传图片 - Ouyang Rong&url=https://ouyangrong.com/posts/UploadImg/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/AnnualSummary-2023/">2023 年度总结</a><li><a href="/posts/AnnualSummary-2022/">2022 年度总结</a><li><a href="/posts/Source-Analysis-SDWebImage/">iOS SDWebImage 源码分析</a><li><a href="/posts/Source-Analysis-AFNetworking/">AFNetworking 源码分析</a><li><a href="/posts/architecture-design/">iOS 架构设计</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/gcd/">GCD</a> <a class="post-tag" href="/tags/objective-c/">Objective-C</a> <a class="post-tag" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag" href="/tags/afnetworking/">AFNetworking</a> <a class="post-tag" href="/tags/%E5%A4%A7%E5%8F%B7/">大号</a> <a class="post-tag" href="/tags/%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/">年度总结</a> <a class="post-tag" href="/tags/%E6%80%BB%E7%BB%93/">总结</a> <a class="post-tag" href="/tags/%E7%BD%91%E7%BB%9C/">网络</a> <a class="post-tag" href="/tags/arc/">ARC</a> <a class="post-tag" href="/tags/fmdb/">FMDB</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/ios-multi-thread-order/"><div class="card-body"> <span class="timeago small" > Dec 10, 2020 <i class="unloaded">2020-12-10T16:14:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>用多线程控制程序执行顺序</h3><div class="text-muted small"><p> 一、按顺序多次从一个接口请求数据 //按顺序请求语数英三门学科的数据； - (void)getAllSubjectHomeworkData { if (self.subjectCountData.list.count == 0) { return; } dispatch_queue_t queueUploadBegin = dispatch_queu...</p></div></div></a></div><div class="card"> <a href="/posts/iOS-Multithreaded-Detailed-Solution/"><div class="card-body"> <span class="timeago small" > Sep 1, 2021 <i class="unloaded">2021-09-01T10:57:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>多线程详解</h3><div class="text-muted small"><p> 概述 在iOS中每个进程启动后都会建立一个主线程（UI线程），这个线程是其他线程的父线程。由于在iOS中除了主线程，其他子线程是独立于Cocoa Touch的，所以只有主线程可以更新UI界面。iOS中多线程使用并不复杂，关键是如何控制好各个线程的执行顺序、处理好资源竞争问题。 我们运用多线程的目的是：将耗时的操作放在后台执行。 进程（Process）：是计算机中的程序关于某数据集...</p></div></div></a></div><div class="card"> <a href="/posts/iOS-In-App-Purchase/"><div class="card-body"> <span class="timeago small" > Jul 13, 2021 <i class="unloaded">2021-07-13T10:57:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>苹果内购</h3><div class="text-muted small"><p> 内购简介 IAP 全称：In-App Purchase，是指苹果 App Store 的应用内购买，是苹果为 App 内购买虚拟商品或服务提供的一套交易系统。 适用范围 在 App 内需要付费使用的产品功能或虚拟商品/服务，如游戏道具、电子书、音乐、视频、订阅会员、App的高级功能等需要使用 IAP，而在 App 内购买实体商品（如淘宝购买手机）或者不在 App 内使用的虚拟商品（...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/AnnualSummary-2022/" class="btn btn-outline-primary" prompt="Older"><p>2022 年度总结</p></a> <a href="/posts/AnnualSummary-2023/" class="btn btn-outline-primary" prompt="Newer"><p>2023 年度总结</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//ouyangrong-1.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'iOS开发-连续拍照异步按顺序批量上传图片'; this.page.url = 'https://ouyangrong.com/posts/UploadImg/'; this.page.identifier = '/posts/UploadImg/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/ouyangrong1313">Ouyang Rong</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/gcd/">GCD</a> <a class="post-tag" href="/tags/objective-c/">Objective C</a> <a class="post-tag" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag" href="/tags/afnetworking/">AFNetworking</a> <a class="post-tag" href="/tags/%E5%A4%A7%E5%8F%B7/">大号</a> <a class="post-tag" href="/tags/%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/">年度总结</a> <a class="post-tag" href="/tags/%E6%80%BB%E7%BB%93/">总结</a> <a class="post-tag" href="/tags/%E7%BD%91%E7%BB%9C/">网络</a> <a class="post-tag" href="/tags/arc/">ARC</a> <a class="post-tag" href="/tags/fmdb/">FMDB</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ouyangrong.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
