<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="处理上传图片太多导致内存崩溃的问题" /><meta name="author" content="Ouyang Rong" /><meta property="og:locale" content="en_US" /><meta name="description" content="问题分析" /><meta property="og:description" content="问题分析" /><link rel="canonical" href="https://ouyangrong.com/posts/ios-img-upload-a-lot/" /><meta property="og:url" content="https://ouyangrong.com/posts/ios-img-upload-a-lot/" /><meta property="og:site_name" content="Ouyang Rong" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-25T16:14:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="处理上传图片太多导致内存崩溃的问题" /><meta name="twitter:site" content="@ouyangrong1313" /><meta name="twitter:creator" content="@Ouyang Rong" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ouyang Rong"},"dateModified":"2021-06-25T18:19:43+08:00","datePublished":"2021-06-25T16:14:00+08:00","description":"问题分析","headline":"处理上传图片太多导致内存崩溃的问题","mainEntityOfPage":{"@type":"WebPage","@id":"https://ouyangrong.com/posts/ios-img-upload-a-lot/"},"url":"https://ouyangrong.com/posts/ios-img-upload-a-lot/"}</script><title>处理上传图片太多导致内存崩溃的问题 | Ouyang Rong</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ouyang Rong"><meta name="application-name" content="Ouyang Rong"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-4EXCTKYR2M"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-4EXCTKYR2M'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/images/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ouyang Rong</a></div><div class="site-subtitle font-italic">Stay Hungry, Stay Foolish.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ouyangrong1313" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/ouyangrong1313" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['951607559','qq.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>处理上传图片太多导致内存崩溃的问题</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>处理上传图片太多导致内存崩溃的问题</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Ouyang Rong </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Jun 25, 2021, 4:14 PM +0800" prep="on" > Jun 25, 2021 <i class="unloaded">2021-06-25T16:14:00+08:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Jun 25, 2021, 6:19 PM +0800" prefix="Updated " > Jun 25, 2021 <i class="unloaded">2021-06-25T18:19:43+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1386 words">7 min</span></div></div><div class="post-content"><h1 id="问题分析">问题分析</h1><p>批量上传图片，当图片多了的时候，内存崩溃了。</p><blockquote><p>Message from debugger: Terminated due to memory issue</p></blockquote><h1 id="解决方法">解决方法</h1><p>创建队列，用信号量，实现图片一张一张上传。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>static SSTUploadHomeworkPictureManager *manager = nil;
static dispatch_queue_t _queueUploadBegin = nil; // 创建串行队列 - 保证多次图片上传请求按顺序执行；
static dispatch_semaphore_t _semaphoreBegin = nil;
static dispatch_queue_t _queueSubmitBegin = nil;
static dispatch_semaphore_t _semaphoreSubmitBegin = nil;
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>+ (instancetype)shareManager{
    return [[self alloc] init];
}

- (instancetype)init{
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        manager = [super init];
        _queueUploadBegin = dispatch_queue_create("com.uploadHomeworkImageToOSS.subsystem.tast", DISPATCH_QUEUE_SERIAL);
        _semaphoreBegin = dispatch_semaphore_create(1); // 设置信号总量为1，保证只有一个进程执行
        _queueSubmitBegin = dispatch_queue_create("com.submitHomeworkImageToOSS.subsystem.tast", DISPATCH_QUEUE_SERIAL);
        _semaphoreSubmitBegin = dispatch_semaphore_create(1);
    });
    return manager;
}
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>-(void)submitHomewrokPhoto:(NSArray&lt;SSTEditTaskSujectFinishedPictureModel *&gt; *)imageModels withVipId:(NSString *)vipId subject:(NSString*)subject {
    self.imageCount = imageModels.count;
    dispatch_async(_queueSubmitBegin, ^{
        dispatch_semaphore_wait(_semaphoreSubmitBegin, DISPATCH_TIME_FOREVER);
        NSMutableArray *uploadPictures = [NSMutableArray array];
        dispatch_queue_t queueUploadImage = dispatch_queue_create("com.submitImageModel.subsystem.tast", DISPATCH_QUEUE_SERIAL);
        dispatch_semaphore_t semaphoreImage = dispatch_semaphore_create(1); // 设置信号总量为1，保证只有一个进程执行；
        for (NSInteger i = 0; i &lt; imageModels.count; i ++) {
            SSTEditTaskSujectFinishedPictureModel *editPicture = [imageModels objectAtIndexCheck:i];
            dispatch_async(queueUploadImage, ^{
                dispatch_semaphore_wait(semaphoreImage, DISPATCH_TIME_FOREVER);
                editPicture.correctStatus = SSTHomeworkPictureStateUploading;
                editPicture.isLocalData = YES;
                editPicture.vipId = vipId;
                editPicture.course = subject;
                [self saveUploadingHomewrokPhoto:editPicture withVipId:vipId subject:subject];
                [uploadPictures addObject:editPicture];
                dispatch_semaphore_signal(semaphoreImage);
                if (i == self.imageCount - 1) {
                    [self uploadImageModelArr:uploadPictures originalPhoto:YES complete:^(SSTEditTaskSujectFinishedPictureModel * _Nonnull imageModel, AliOSSUploadImageState state) {                        
                        dispatch_semaphore_signal(_semaphoreSubmitBegin);
                    }];
                }
            });
        }
    });
}
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
</pre><td class="rouge-code"><pre>- (void)uploadImageModelArr:(NSArray&lt;SSTEditTaskSujectFinishedPictureModel *&gt; *)imageModelArr originalPhoto:(BOOL)originalPhoto complete:(void(^)(SSTEditTaskSujectFinishedPictureModel *imageModel, AliOSSUploadImageState state))complete {
    NSLog(@" =========== uploadImageModelArr ========= start--%@",[NSThread currentThread]);
    dispatch_async(_queueUploadBegin, ^{
        //等待信号量
        dispatch_semaphore_wait(_semaphoreBegin, DISPATCH_TIME_FOREVER);
        //网络请求上传图片数据
        [XWHttpClient xw_postWithUrlString:HTTP_upload_getOssfsToken Params:nil DefaultHUD:NO SuccessBlock:^(id returnValue) {
            NSLog(@"  ----- getOssfsToken - returnValue： %@",returnValue);
            NSLog(@" =========== HTTP_upload_getOssfsToken ========= start--%@",[NSThread currentThread]);
            OssfsTokenModel *ossfsTokenModel = [OssfsTokenModel mj_objectWithKeyValues:DicGetValue(returnValue,@"data")];
            id&lt;OSSCredentialProvider&gt; credential = [[OSSStsTokenCredentialProvider alloc] initWithAccessKeyId:ossfsTokenModel.accessKeyId secretKeyId:ossfsTokenModel.accessKeySecret securityToken:ossfsTokenModel.securityToken];
            OSSClient *client = [[OSSClient alloc] initWithEndpoint:ossfsTokenModel.endpoint credentialProvider:credential];
            OSSPutObjectRequest *put = [OSSPutObjectRequest new];
            put.bucketName = ossfsTokenModel.bucket;
            NSOperationQueue *queue = [[NSOperationQueue alloc] init];
            queue.maxConcurrentOperationCount = imageModelArr.count;

            //创建串行队列
            dispatch_queue_t queueUpload = dispatch_queue_create("com.uploadLocalPicture.subsystem.tast", DISPATCH_QUEUE_SERIAL);
            //设置信号总量为1，保证只有一个进程执行
            dispatch_semaphore_t semaphore = dispatch_semaphore_create(1);

            for (int i = 0; i &lt; imageModelArr.count; i ++) {
                SSTEditTaskSujectFinishedPictureModel *imageModel = imageModelArr[i];
                imageModel.index = i;
                dispatch_async(queueUpload, ^{
                    //等待信号量
                    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);

                    //处理耗时操作的代码块...
                    dispatch_async(dispatch_get_global_queue(0, 0), ^{
                        UIImage *image = imageModel.localImage;
                        if (image) { // image
                            NSBlockOperation *operation = [NSBlockOperation blockOperationWithBlock:^{
                            NSData *data;
                            NSData *data1 = UIImageJPEGRepresentation(image, 0.5);
                            float length1 = [data1 length] / 1024;
                            if (length1 &lt; 400) {
                                data = data1; //UIImageJPEGRepresentation(image, 1);
                            }else {
                                if (originalPhoto) {
                                    data = UIImageJPEGRepresentation(image, 0.5); // 原图
                                }else {
                                    data = UIImageJPEGRepresentation(image, 0.3); // 再压缩一下
                                }
                            }
                            NSString *imageName = [NSString stringWithFormat:@"/iOS/%@%d.jpg",[SSUtility getTransactionID],i];  //加“i”防止数组图片重名
                            //imageModel.localPath = [NSString stringWithFormat:@"%@%d.jpg",[SSUtility getTransactionID],i]; // 用于本地保存，如果上传失败的话；
                            put.objectKey = [imageName substringFromIndex:1];
                            NSTimeInterval endTime = [[NSDate date] timeIntervalSince1970]*1000;// *1000 是精确到毫秒，不乘就是精确到秒
                            NSInteger uploadTime = endTime;
                            imageModel.derverFileId = imageModel.derverFileId.length?imageModel.derverFileId:[NSString stringWithFormat:@"%@-%zd",imageModel.vipId,uploadTime];
                            put.uploadingData = data;
                            put.uploadProgress = ^(int64_t bytesSent, int64_t totalByteSent, int64_t totalBytesExpectedToSend) {
                             NSLog(@" -- 这是第 %d 张图片 %@ 在上传--- bytesSent %lld, - totalByteSent %lld, - totalBytesExpectedToSend %lld", i,imageName,bytesSent, totalByteSent, totalBytesExpectedToSend);
                            };
                            NSString *paramBody = @"{\"vipId\":${x:vipId},\"courseName\":${x:courseName},\"derverFileId\":${x:derverFileId},\"fileKeys\":${x:fileKeys},\"questionRecommendRecordId\":${x:questionRecommendRecordId}}";
                            put.callbackParam = @{@"callbackUrl":[NSString stringWithFormat:@"%@%@?accessToken=%@",kUPLOAD_ADDRESS,HTTP_End_Path(HTTP_LibraryTeacher,@"uploadPicture"),[SSUtility getTeacherToken]],
                                                 @"callbackBody":paramBody,
                                             @"callbackBodyType":@"application/json"
                                                }; // library/V2
                            put.callbackVar = @{@"x:vipId":imageModel.vipId,
                                           @"x:courseName":imageModel.course,
                                             @"x:fileKeys":imageName,
                                         @"x:derverFileId":imageModel.derverFileId,
                            @"x:questionRecommendRecordId":imageModel.questionRecommendRecordId.length?imageModel.questionRecommendRecordId:@""};
                            OSSTask *putTask = [client putObject:put];
                            [putTask waitUntilFinished]; // 阻塞直到上传完成
                            [putTask continueWithBlock:^id(OSSTask *task) {
                                OSSPutObjectResult *result = (OSSPutObjectResult *)task.result;
                                NSLog(@"Result - requestId: %@,\n headerFields: %@,\n servercallback: %@",
                                            result.requestId,
                                            result.httpResponseHeaderFields,
                                            result.serverReturnJsonString);
                                NSDictionary *dataDict = [SSUtility dictionaryWithJsonString:result.serverReturnJsonString];
                                NSString *codeStr = dataDict[@"code"];
                                NSString *msgStr = dataDict[@"msg"];

                                // 还要从后台返回数据判断是否上服务器成功
                                if ([codeStr isEqualToString:@"999"]) {
                                    NSLog(@"upload object success!");
                                    // 删除上传中
                                    [[SSTUploadHomeworkPictureManager shareManager] deleteUploadingPhoto:imageModel withVipId:imageModel.vipId subject:imageModel.course];
                                    if (complete) {
                                        complete(imageModel ,AliOSSUploadImageSuccess);
                                    }
                                }else {
                                    NSLog(@"请求服务器失败：%@",msgStr.length?msgStr:task.error);
                                    dispatch_async(dispatch_get_main_queue(), ^{
                                        [[SSCustomAlertView alloc] setAlertViewTitle:@"" andMessage:msgStr ? msgStr : @"作业上传失败" andhideAlertViewTimeOut:kDefaultAlertTime];
                                    });
                                    imageModel.correctStatus = SSTHomeworkPictureStateUploadFail;
                                    [[SSTUploadHomeworkPictureManager shareManager] saveUploadFailurePhoto:imageModel withVipId:imageModel.vipId subject:imageModel.course];
                                    [[SSTUploadHomeworkPictureManager shareManager] deleteUploadingPhoto:imageModel withVipId:imageModel.vipId subject:imageModel.course];
                                    if (complete) {
                                        complete(imageModel ,AliOSSUploadImageFailed);
                                    }
                                }

                                dispatch_semaphore_signal(semaphore);
                                //最后一张上传完了，这个请求结束了；
                                if (imageModel == imageModelArr.lastObject) { //要是按顺序来的才能这么判断；
                                    NSLog(@" --- 网络请求上传图片数据 --- upload object finished!");
                                    dispatch_semaphore_signal(_semaphoreBegin);
                                }

                                task = [client presignPublicURLWithBucketName:ossfsTokenModel.bucket withObjectKey:put.objectKey];
                                return nil;
                            }];

                            }];

                            if (queue.operations.count != 0) {
                                [operation addDependency:queue.operations.lastObject];
                            }
                            [queue addOperation:operation];

                        }else { //没有图片，让线程继续执行；当做是失败；
                            imageModel.correctStatus = SSTHomeworkPictureStateUploadFail;
                            [[SSTUploadHomeworkPictureManager shareManager] saveUploadFailurePhoto:imageModel withVipId:imageModel.vipId subject:imageModel.course];
                            [[SSTUploadHomeworkPictureManager shareManager] deleteUploadingPhoto:imageModel withVipId:imageModel.vipId subject:imageModel.course];
                            dispatch_semaphore_signal(semaphore);
                            if (complete) {
                                 complete(imageModel ,AliOSSUploadImageFailed);
                            }
                        }

                    }); // 子线程操作

                }); // 等待信号量

            } // 遍历图片

            [queue waitUntilAllOperationsAreFinished];

        } ErrorBlock:^(id errorCode) {
            dispatch_semaphore_signal(_semaphoreBegin);
            for (SSTEditTaskSujectFinishedPictureModel *pictureImageModel in imageModelArr) { // 上传中的作业置为上传失败
                pictureImageModel.correctStatus = SSTHomeworkPictureStateUploadFail;
                [[SSTUploadHomeworkPictureManager shareManager] saveUploadFailurePhoto:pictureImageModel withVipId:pictureImageModel.vipId subject:pictureImageModel.course];
                [[SSTUploadHomeworkPictureManager shareManager] deleteUploadingPhoto:pictureImageModel withVipId:pictureImageModel.vipId subject:pictureImageModel.course];
                if (complete) {
                    complete(pictureImageModel ,AliOSSUploadImageFailed);
                }
            }
        } FailureBlock:^(id failureInfo) {
            dispatch_semaphore_signal(_semaphoreBegin);
            for (SSTEditTaskSujectFinishedPictureModel *pictureImageModel in imageModelArr) { // 上传中的作业置为上传失败
                pictureImageModel.correctStatus = SSTHomeworkPictureStateUploadFail;
                [[SSTUploadHomeworkPictureManager shareManager] saveUploadFailurePhoto:pictureImageModel withVipId:pictureImageModel.vipId subject:pictureImageModel.course];
                [[SSTUploadHomeworkPictureManager shareManager] deleteUploadingPhoto:pictureImageModel withVipId:pictureImageModel.vipId subject:pictureImageModel.course];
                if (complete) {
                    complete(pictureImageModel ,AliOSSUploadImageFailed);
                }
            }
        }];
    }); // 等待信号量

}
</pre></table></code></div></div><h1 id="错误示范">错误示范</h1><p>这种方法开辟子线程太多了，十分消耗内存，也会造成内存崩溃。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    dispatch_async(queue, ^{
        NSMutableArray *uploadPictures = [NSMutableArray array];
        dispatch_group_t group = dispatch_group_create();
        for (SSTEditTaskSujectFinishedPictureModel *editPicture in imageModels) {
            dispatch_group_async(group, queue, ^{
                editPicture.correctStatus = SSTHomeworkPictureStateUploading;
                editPicture.isLocalData = YES;
                editPicture.vipId = vipId;
                editPicture.course = subject;
                NSLog(@" -- 上传 保存 作业 图片 当前线程 -- %@",[NSThread currentThread]);
                [self saveUploadingHomewrokPhoto:editPicture withVipId:vipId subject:subject];
                [uploadPictures addObject:editPicture];
            });
        }
        dispatch_group_wait(group, DISPATCH_TIME_FOREVER);
        dispatch_group_notify(group, queue, ^{
            if (uploadPictures.count &gt; 0) {
                [self uploadImageModelArr:uploadPictures originalPhoto:YES complete:^(SSTEditTaskSujectFinishedPictureModel * _Nonnull imageModel, AliOSSUploadImageState state) {
                    SSLog(@" --- 作业上传 --- 完成 --- ");
                }];
            }
        });
    });
</pre></table></code></div></div><h1 id="其他方法">其他方法</h1><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gruny0r7atj30u00znwj0.jpg" alt="作业图片1" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://tva1.sinaimg.cn/large/008i3skNgy1grunycb38aj60u01h3k0102.jpg" alt="作业图片2" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://tva1.sinaimg.cn/large/008i3skNgy1grunyk1yo5j30u01a27ar.jpg" alt="作业图片3" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://tva1.sinaimg.cn/large/008i3skNgy1grunz8u60wj30xc02cjrd.jpg" alt="作业图片4" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ios/'>iOS</a>, <a href='/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/'>多线程</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/uiimage/" class="post-tag no-text-decoration" >UIImage</a> <a href="/tags/%E5%86%85%E5%AD%98/" class="post-tag no-text-decoration" >内存</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=处理上传图片太多导致内存崩溃的问题 - Ouyang Rong&url=https://ouyangrong.com/posts/ios-img-upload-a-lot/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=处理上传图片太多导致内存崩溃的问题 - Ouyang Rong&u=https://ouyangrong.com/posts/ios-img-upload-a-lot/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=处理上传图片太多导致内存崩溃的问题 - Ouyang Rong&url=https://ouyangrong.com/posts/ios-img-upload-a-lot/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/AnnualSummary-2023/">2023 年度总结</a><li><a href="/posts/AnnualSummary-2022/">2022 年度总结</a><li><a href="/posts/Source-Analysis-SDWebImage/">iOS SDWebImage 源码分析</a><li><a href="/posts/Source-Analysis-AFNetworking/">AFNetworking 源码分析</a><li><a href="/posts/architecture-design/">iOS 架构设计</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/gcd/">GCD</a> <a class="post-tag" href="/tags/objective-c/">Objective-C</a> <a class="post-tag" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag" href="/tags/afnetworking/">AFNetworking</a> <a class="post-tag" href="/tags/%E5%A4%A7%E5%8F%B7/">大号</a> <a class="post-tag" href="/tags/%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/">年度总结</a> <a class="post-tag" href="/tags/%E6%80%BB%E7%BB%93/">总结</a> <a class="post-tag" href="/tags/%E7%BD%91%E7%BB%9C/">网络</a> <a class="post-tag" href="/tags/arc/">ARC</a> <a class="post-tag" href="/tags/fmdb/">FMDB</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/ios-multi-thread-order/"><div class="card-body"> <span class="timeago small" > Dec 10, 2020 <i class="unloaded">2020-12-10T16:14:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>用多线程控制程序执行顺序</h3><div class="text-muted small"><p> 一、按顺序多次从一个接口请求数据 //按顺序请求语数英三门学科的数据； - (void)getAllSubjectHomeworkData { if (self.subjectCountData.list.count == 0) { return; } dispatch_queue_t queueUploadBegin = dispatch_queu...</p></div></div></a></div><div class="card"> <a href="/posts/iOS-Multithreaded-Detailed-Solution/"><div class="card-body"> <span class="timeago small" > Sep 1, 2021 <i class="unloaded">2021-09-01T10:57:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>多线程详解</h3><div class="text-muted small"><p> 概述 在iOS中每个进程启动后都会建立一个主线程（UI线程），这个线程是其他线程的父线程。由于在iOS中除了主线程，其他子线程是独立于Cocoa Touch的，所以只有主线程可以更新UI界面。iOS中多线程使用并不复杂，关键是如何控制好各个线程的执行顺序、处理好资源竞争问题。 我们运用多线程的目的是：将耗时的操作放在后台执行。 进程（Process）：是计算机中的程序关于某数据集...</p></div></div></a></div><div class="card"> <a href="/posts/iOS-YYKit-CodeLearn/"><div class="card-body"> <span class="timeago small" > Jan 7, 2022 <i class="unloaded">2022-01-07T18:11:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>iOS YYKit 源码学习</h3><div class="text-muted small"><p> YYKit 框架的作者是现任职于滴滴的郭曜源（ibireme）。 最近一系列开源项目 YYKit 在 iOS 社区引起广泛反响，由于其代码质量高，在短时间内就收获了大量的 star，它的作者是国人开发者 ibireme，优酷土豆的 iOS 开发工程师郭曜源，InfoQ 社区编辑唐巧对他进行了采访，了解这些开源项目背后的故事。 大家好，我叫郭曜源，是一个 iOS 开发者，现居北京，...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/ios-network-request-optimize-multithreading/" class="btn btn-outline-primary" prompt="Older"><p>多线程 - 重复网络请求优化</p></a> <a href="/posts/ios-pdf-webView-local/" class="btn btn-outline-primary" prompt="Newer"><p>本地先下载PDF文件，再用WKWebView显示</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//ouyangrong-1.disqus.com/embed.js', disqusConfig: function() { this.page.title = '处理上传图片太多导致内存崩溃的问题'; this.page.url = 'https://ouyangrong.com/posts/ios-img-upload-a-lot/'; this.page.identifier = '/posts/ios-img-upload-a-lot/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/ouyangrong1313">Ouyang Rong</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/gcd/">GCD</a> <a class="post-tag" href="/tags/objective-c/">Objective C</a> <a class="post-tag" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag" href="/tags/afnetworking/">AFNetworking</a> <a class="post-tag" href="/tags/%E5%A4%A7%E5%8F%B7/">大号</a> <a class="post-tag" href="/tags/%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/">年度总结</a> <a class="post-tag" href="/tags/%E6%80%BB%E7%BB%93/">总结</a> <a class="post-tag" href="/tags/%E7%BD%91%E7%BB%9C/">网络</a> <a class="post-tag" href="/tags/arc/">ARC</a> <a class="post-tag" href="/tags/fmdb/">FMDB</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ouyangrong.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
